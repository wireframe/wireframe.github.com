---
layout: post
title: "The End Of Dependency Injection"
date: 2008-08-09
comments: false
categories:
 - ruby
 - java
 - testing
---

<div class='post'>
Dependency Injection is a common technique in Java applications.&nbsp; I have a long history of Java development in a Test Driven Development environment so Dependency Injection has been a way of life for a long time.&nbsp; It's a tried and true practice and is an absolute <i>requirement</i> when developing Java software, but it's simply not needed when working with a dynamic language like Ruby.&nbsp; Why?<br /><br />If you want to write testable Java code, you <b>NEED</b> Dependency Injection.&nbsp; Let's start with an example.<br /><br /><pre>//Java Code Without Dependency Injection</pre><pre>public class MyService &#123;</pre><pre>&nbsp; public void doWork() &#123;</pre><pre>&nbsp;&nbsp;&nbsp; DatabaseConnection connection = new DatabaseConnection();</pre><pre>&nbsp;&nbsp;&nbsp; connection.commit();</pre><pre>&nbsp; &#125;</pre><pre>&#125;</pre><br />What makes this previous block of Java code untestable?&nbsp; It's because of the &quot;new&quot; keyword.&nbsp; In Java, &quot;new&quot; is a magic keyword and there's nothing you can do to circumvent the code that executes when it fires. In order to test the my code with various DatabaseConnection behavior, you need to inject the DatabaseConnection so unit tests can configure the expected behavior.<br /><br /><pre>//Java Code With Dependency Injection</pre><pre>public class MyService &#123;</pre><pre>&nbsp; private final DatabaseConnection connection;</pre><pre>&nbsp; public MyService(DatabaseConnection connection) &#123;</pre><pre>&nbsp;&nbsp;&nbsp; this.connection = connection;</pre><pre>&nbsp; &#125;</pre><pre>&nbsp; public void doWork() &#123;</pre><pre>&nbsp;&nbsp;&nbsp; connection.commit();</pre><pre>&nbsp; &#125;</pre><pre>&#125;</pre><br />It's unfortunate that making my code &quot;testable&quot; <b>doubles</b> the amount of code.&nbsp; It also <b>reduces</b> context of the code and makes its purpose less clear.&nbsp; Is this <i>really</i> necessary?&nbsp; In Ruby, &quot;new&quot; is just another method that you can easily override to facilitate testing and you don't need to make any changes to your class to inject test dependencies.<br /><br /><pre>#Ruby Code</pre><pre>class MyService</pre><pre>&nbsp; def do_work</pre><pre>&nbsp;&nbsp;&nbsp; connection = DatabaseConnection.new</pre><pre>&nbsp;&nbsp;&nbsp; connection.commit</pre><pre>&nbsp; end</pre><pre>end</pre><br />This Ruby code is just as testable as the previous Java example and there's no Dependency Injection required.&nbsp; Instead of having to &quot;jump through hoops&quot; and inject the DatabaseConnection object into my class, I can just override the DatabaseConnection.new method to return a testable mock implementation.<br /><br /><pre>require 'mocha'</pre><pre><br />class MyServiceTest &lt; ActiveSupport::TestCase</pre><pre>&nbsp; def test_can_mock_connection</pre><pre>&nbsp;&nbsp;&nbsp; fake_connection = mock</pre><pre>&nbsp;&nbsp;&nbsp; fake_connection.expects(:commit)</pre><pre><br />&nbsp;&nbsp;&nbsp; DatabaseConnection.expects(:new).returns(fake_connection)</pre><pre><br />&nbsp;&nbsp;&nbsp; service = MyService.new</pre><pre>&nbsp;&nbsp;&nbsp; service.do_work</pre><pre>&nbsp; end</pre><pre>end</pre><br />This sample test uses the excellent <a href="http://mocha.rubyforge.org/">mocha mock library</a>, which is very similar to JMock, to inject the test implementation.&nbsp; You can accomplish the same thing with standard ruby code, but the mocha library provides a very nice API for injecting test dependencies.&nbsp; The real difference here is that Ruby is an <b>open</b> language that allows for overriding implementation details.&nbsp; The beauty of Ruby is that this same approach can be applied to other areas that are normally very tricky for testing Java code (ex: static methods).<br /><br />Some may raise the argument that Dependency Injection is intended for externalizing configuration to allow for multiple implementations, and <i>not</i> intended for increasing testability.&nbsp; That is a joke.&nbsp; When was the last time you used more than one implementation for your injected object?&nbsp; In reality, there are only two implementations.&nbsp; The <i>real</i> implementation, and the <i>mock</i> implementation used for testing.&nbsp; Dependency Injection is used for testability, not configuration. Period.<br /><br /></div>
