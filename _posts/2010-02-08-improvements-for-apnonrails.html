---
layout: post
title: "Improvements for apn_on_rails"
date: 2010-02-08
comments: false
categories:
 - rails
 - apple
---

<div class='post'>
<img src="http://img.skitch.com/20100208-jn32ew6kynj5qm4qwqdaw9hcki.jpg" /><br /><br />If you're using Rails and integrate with Apple Push Notifications, you are more than likely familiar with the <a href="http://github.com/markbates/apn_on_rails">apn_on_rails gem</a>.  It's a fantastic library and has been critical for getting off the ground with push notifications quickly.  The project is <a href="http://www.metabates.com/2009/12/21/apn-on-rails-needs-a-home/">currently in flux</a> and has been missing some critical features, so I decided to dig into the source myself and hack away.<br /><br />Using&nbsp;<a href="http://developer.apple.com/IPhone/library/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/ApplePushService/ApplePushService.html#//apple_ref/doc/uid/TP40008194-CH100-SW15">custom metadata to each push notification</a>&nbsp;was needed right off the bat.  Basic push notifications support a "badge", "alert", and "sound", but custom attributes can be used to push metadata that would be useful for your native application.  The original apn_on_rails plugin does not support custom attributes, but after building on the <a href="http://github.com/lmarburger/apn_on_rails">work done by lmarburger</a>, custom payload attributes are working great.<br /><br />Truncation of alert text is another critical feature that needed some love.  Apple limits push notifications to a maximum of 255 characters which&nbsp;<b>includes</b>&nbsp;the alert text and <b>all</b>&nbsp;custom attributes so it is very important to optimize the data you're sending down and not go over the 255 character limit.  The initial gem used a very simple implementation for truncating the text, which worked fine until you started to push custom attributes as well.  Those valuable characters got eaten up in a hurry and the truncation of the alert text needed to be aware of your entire payload length.<br /><br />With a few hours of work, the entire truncation algorithm has been rewritten (with tests) and is working great.  This new algorithm will dynamically truncate your alert text based on your entire payload body.  This is a much better algorithm for text truncation and I've seen a <b>20% increase</b>&nbsp;in the amount of text sent with push alerts before the truncation kicks in (average from 179 to 215 characters).  <br /><br />I also fixed a pretty major bug when truncating notifications with multibyte characters.  Anyone using apn_on_rails for an internationalized app should definitely consider the update.<br /><br />My fork of the original apn_on_rails gem is available <a href="http://github.com/wireframe/apn_on_rails">on github</a>&nbsp;and the&nbsp;updated gem is published and&nbsp;available <a href="http://gemcutter.org/gems/wireframe-apn_on_rails">on gemcutter</a>.</div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>jmettraux</div>
<div class='content'>
Nice enhancements, wiping out almost completely the name of the original author is rather &quot;unfair&quot; though.</div>
</div>
</div>
