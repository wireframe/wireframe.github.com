---
layout: post
title: "Rails Fail with Unicode JSON"
date: 2009-10-29
comments: false
categories:
 - rails
---

<div class='post'>
<img src="http://farm1.static.flickr.com/29/63397800_9055171bae.jpg" /><br /><h2>How to break nearly any Rails app using&nbsp;JSON&nbsp;in 3 simple steps</h2><br /><ol><li>Store unicode characters in the database (\020 or \221 or pretty much any other unicode character)</li><li>Request JSON representation of data</li><li>Watch your clients crash and burn (IE7 and PHP parsers in particular will hack and die on the JSON response)</li></ol><br />Here's a quick testcase to show the issue.  Fire up your script/console to try it out:<br /><pre>'bad characters'.concat(16).to_json =&gt; ""bad characters\020""<br /></pre><br />Notice anything special about the rendered string?  How about the fact that it's&nbsp;<b>invalid</b> JSON?!?  Unicode characters need to be escaped, and the proper response should be:<br /><pre>=&gt; ""bad characters\u0010""<br /></pre><br />The most common way I've seen these unicode characters get into the database is when someone copies text from a word document and pastes it into my application.  It's not extremely common, but that's no excuse for rendering invalid responses.<br /><br />The <a href="http://json.rubyforge.org/">ruby json gem</a> encodes the unicode characters correctly and the Rails implementation is pretty busted. Rails has a pluggable backend for <b>parsing</b>&nbsp;JSON (<code>ActiveSupport::JSON.backend</code>), so why not delegate the <code>ActiveSupport::JSON.encode</code> method to the same implementation?<br /><br />Please vote for this lighthouse ticket to get JSON encoding in Rails up to snuff!<br /><a href="https://rails.lighthouseapp.com/projects/8994/tickets/3345-to_json-does-not-escape-unicode-characters#ticket-3345-1">https://rails.lighthouseapp.com/projects/8994/tickets/3345-to_json-does-not-escape-unicode-characters#ticket-3345-1</a><br /><br /><strong>UPDATE:</strong> A patch has been <a href="http://github.com/rails/rails/commit/a9002056761a481589852d6e8680f752a5b823b7">submitted and accepted</a> into the rails core that should fix this issue with the next release.  Hopefully this doesn't have to wait till the Rails 3.0 release!</div>
