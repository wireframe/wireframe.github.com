---
layout: post
title: "Multitenant Ruby Gem"
date: 2011-03-03
comments: false
categories:
 - ruby
 - multitenant
 - security
---

<div class='post'>
<img src="http://farm3.static.flickr.com/2177/2208105981_00668ccc54.jpg" /><br /><i>Multitenant: locking down your app and making cross tenant data leaks a thing of the past...since 2011</i><br /><br />Designing multi-tenant applications has increasingly becoming the norm for software developers.  The benefits of building an application with a multi-tenant architecture are almost too many to list (cost savings, data mining, simplified operations, etc).  But, let there be no doubt that building a multi-tenant application increases the overall complexity of the application.<br /><br />The <a href="https://github.com/wireframe/multitenant">Multitenant gem</a> helps alleviate that complexity and ensures that all SQL queries executed adhere to the scoping of the current tenant.  It works with any Rails3 compatible application without any modifications to your existing schema.<br /><br />To configure, add the <code>belongs_to_multitenant</code> declaration to any model that has an association to a particular tenant. &nbsp;This will inject a new SQL scope into your model.<br /><pre>class User &lt; ActiveRecord::Base<br />  belongs_to :tenant<br />  belongs_to_multitenant<br />end</pre><br />Now, all queries executed within the <code>Multitenant.with_tenant</code> block will automatically be scoped to the current tenant.  No longer must you worry about a stray <code>MyModel.all</code> call exposing data to the wrong users!  Also, any new records created within this block will automatically be associated to the current tenant.  Another win for ensuring data separation!<br /><pre># use an Rails around_filter to setup this block<br />Multitenant.with_tenant current_tenant do<br />  # queries within this block are automatically<br />  # scoped to the current tenant<br />  User.all<br /><br />  # records created within this block are<br />  # automatically assigned to the current tenant<br />  User.create :name =&gt; 'Bob'<br />end</pre><br />Unintentionally leaking data between tenants should be the <b>NUMBER ONE</b> concern when building multi-tenant apps and it surprises me how few resources are available to assist developers in building multi-tenant apps and ensuring data separation between tenants.  So, if you're building a multi-tenant Rails app, make sure the <a href="https://github.com/wireframe/multitenant">Multitenant gem</a> is in your toolbox!<br /><br />Source code is 100% opensource and available on Github:<br /><a href="https://github.com/wireframe/multitenant">https://github.com/wireframe/multitenant</a><br /><br />Gem is available on rubygems:<br /><a href="https://rubygems.org/gems/multitenant">https://rubygems.org/gems/multitenant</a></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
What are the advantages of your approach over the approach suggested by Guy Naor in acts_as_conference 2009? (Google for the Confreaks video of his talk.) Thanks</div>
</div>
<div class='comment'>
<div class='author'>misbehavens</div>
<div class='content'>
Awesome! Thank you! This will save me so much time! I look forward to trying it out. =]</div>
</div>
<div class='comment'>
<div class='author'>Arik Fraimovich</div>
<div class='content'>
I&#39;ve noticed that you&#39;re using the DynamicDefaultScoping to create the scoping. Doesn&#39;t that mean that the belongs_to_multitenant call should be placed after all other scopes?</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
ryan, good work and i agree - there is a surprising lack of multitenant support in the Rails community considering how popular this approach is becoming so you&#39;re on the money here! can i ask, how would you implement your code alongside the Rails3 subdomain helper? e.g. http://area1.mydomain.com and http://area2.mydomain.com such that the subdomain is the tenant (doesn&#39;t require any authentication as it is just a hop between areas and thus content for those areas). i&#39;d be happy to support your work here with a little contribution if you could help? thanks in advance.</div>
</div>
<div class='comment'>
<div class='author'>Gopi Krishna</div>
<div class='content'>
I tried using your gem, getting an error:<br />  undefined method `foreign_key&#39; for nil:NilClass<br />Any pointers on what could be going wrong?<br />my code:<br />+ i have added an around_filter :<br />    Multitenant.with_tenant my_tenant_obj do<br />      yield<br />    end<br />+ added in model<br />    belongs_to :ModelName<br />    belongs_to_multitenant</div>
</div>
<div class='comment'>
<div class='author'>Kartik</div>
<div class='content'>
I am using MYSQL for my Ruby web application and I want to use the option of one DB per tenant, can anyone share any sample or tutorial to achieve the same?</div>
</div>
<div class='comment'>
<div class='author'>Kartik</div>
<div class='content'>
I am using MYSQL for my Ruby web application and I want to use the option of one DB per tenant, can anyone share any sample or tutorial to achieve the same?</div>
</div>
<div class='comment'>
<div class='author'>Ryan Sonnek</div>
<div class='content'>
@kartik using separate databases per tenant is called &quot;sharding&quot; and is a very different approach than multi-tenancy.<br /><br />there are plenty of good docs and tutorials across the web to discuss sharding if you are pursue that approach.</div>
</div>
<div class='comment'>
<div class='author'>Nathan</div>
<div class='content'>
Hi Ryan,<br /><br />I&#39;m wondering how your gem handles situations where two or more users are requesting data at the same time?  Seems your managing state in the the Multitenant constant, using class attr_accessor methods.  If that&#39;s the case, is it possible that the @current_tenant could get swapped, resulting in a tenant data leak?<br /><br />Thanks,<br />Nathan</div>
</div>
<div class='comment'>
<div class='author'>Nathan</div>
<div class='content'>
Hi Ryan,<br /><br />I&#39;m wondering how your gem handles situations where two or more users are requesting data at the same time?  Seems your managing state in the the Multitenant constant, using class attr_accessor methods.  If that&#39;s the case, is it possible that the @current_tenant could get swapped, resulting in a tenant data leak?<br /><br />Thanks,<br />Nathan</div>
</div>
<div class='comment'>
<div class='author'>Ryan Sonnek</div>
<div class='content'>
@Nathan<br /><br />most rails applications are thread safe so cross thread data access is not an issue.<br /><br />if multithread access is required, storing the current_tenant in a thread local variable would be the way to go.<br /><br />patches are always welcome!</div>
</div>
<div class='comment'>
<div class='author'>Konstantin Rudy</div>
<div class='content'>
Hey Ryan,<br /><br />As of now I have found a very severe issue which prevents from using the gem in production systems: https://github.com/wireframe/multitenant/issues/11<br />Can you please address this issue, as it seems to be 2 month already and no attention paid to it<br /><br />Thanks,<br />Konstantin</div>
</div>
</div>
