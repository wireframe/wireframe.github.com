---
layout: post
title: "HSQLDB Datasource"
date: 2007-02-13
comments: false
categories:
 - java
 - database
---

<div class='post'>
<p>I use <a href="http://hsqldb.org">HSQLDB</a> in my development environment, and for the most part it works great.  I ran into a recent issue though that caught me off guard.</p><br /><br /><p>As you may (or may not) know, HSQLDB only allows for one connection to the database at a time.  Most applications will work fine with this limitation, unless you have an <i>embedded</i> application that can be started and restarted within the same JVM.</p><br /><br /><p>HSQLDB uses a JVM shutdown hook to release the database lock which can be an issue if your application doesn't kill the JVM when "shutting down".  Here's a scenerio when this can be an issue:</p><br /><ol><br />  <li>Embedded application starts up.  A new JVM is initialized.</li><br />  <li>Database <code>Datasource</code> starts up and connects to the database.  HSQLDB will create the file lock.</li><br />  <li>Embedded application is shutdown. The JVM does not exit.</li><br />  <li><code>Datasource</code> closes, but HSQLDB does not release the file lock since the JVM did not exit.</li><br />  <li>Embedded application is restarted in the same JVM.</li><br />  <li>Database <code>Datasource</code> starts up and tries to connect to the database.  A big fat stacktrace is thrown because the HSQLDB database is still locked from the previous instance.</li><br /></ol><br /><br /><p>So, I did a bit of searching and found that you can <i>manually</i> tell HSQLDB to shutdown and release the database lock.  Here's a nice little extension to the <a href="http://jakarta.apache.org/commons/dbcp/">commons dbcp</a> <code>Datasource</code> that will correctly shutdown HSQLDB when the <code>Datasource</code> is closed.</p><br /><br /><pre><br />/**<br /> * Datasource that shuts down the hsqldb when the data source is closed.<br /> * hsql is normally only shutdown with a JVM hook, so this datasource is<br /> * better suited when you need to shutdown/restart within one JVM.<br /> *<br /> * @see http://hsqldb.org<br /> */<br />public class HsqldbDataSource extends BasicDataSource &#123;<br />        @Override<br />        public synchronized void close() throws SQLException &#123;<br />                Connection conn = getConnection();<br />                Statement statement = conn.createStatement();<br />                statement.executeUpdate("SHUTDOWN");<br />                statement.close();<br />                conn.close();<br /><br />                super.close();<br />        &#125;<br />&#125;<br /></pre></div>
