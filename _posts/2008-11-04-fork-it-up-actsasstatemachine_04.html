---
layout: post
title: "Fork it up - acts_as_state_machine"
date: 2008-11-04
comments: false
categories:
 - ruby
---

<div class='post'>
<p>Consider the following class definition:</p><br /><pre class="code"><br />class Door &lt; ActiveRecord::Base<br />  acts_as_state_machine :initial =&gt; :open<br />  state :closed<br />  state :open<br />  event :lock do<br />    transitions :from =&gt; :open, :to =&gt; closed<br />  end<br />  event :unlock do<br />    transitions :from =&gt; :closed, :to =&gt; open<br />  end<br />end<br /></pre><br /><p>Now, what is wrong with this script?</p><br /><pre class="code"><br />door = Door.new<br /><br />door.lock! #=&gt; closes the door<br />door.lock! #=&gt; doesn't do anything.  door is already closed<br /></pre><br /><br /><p>The script <strong><em>should</em></strong> produce an error because the <em>lock</em> event does not have a valid transition when the door is already in the <em>closed</em> state.  Instead, the current <em>acts_as_state_machine</em> plugin quietly returns <em>false</em> if<br />there is no valid transition.  That definitely isn't what I expected<br />and seriously took me several hours to track down this mysterious<br />behavior.</p><br /><br /><p>I have published <a title="a fork of the acts_as_state_machine project" href="http://github.com/wireframe/acts_as_state_machine/tree/master" id="wf_5">a fork of the <em>acts_as_state_machine</em> project</a> which <em><strong>correctly</strong></em> raises exceptions if there are no valid transitions available.  The code change is very minor if you want to apply a patch to your own install.</p><br /><br /><p>There's an entire rant just ripe for the picking, but I'll save that for<br />another time.  For now, I've &quot;scratched my own itch&quot; and have made a<br />library work much more intuitively for me.  I'm happy...  =)</p></div>
