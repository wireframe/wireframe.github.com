---
layout: post
title: "Hibernate LoadAll Feature"
date: 2007-02-12
comments: false
categories:
 - java
 - hibernate
 - database
---

<div class='post'>
<p>I've used <a href="http://hibernate.org">Hibernate</a> off and on over the years, and just recently discovered one of its weirdest <i>features</i>.</p><br /><br /><p>I'll setup a simple test scenerio to best illustrate the behavior.&nbsp; First, I'll create a persistent object that has a mapped <code>Collection</code>. The classic <code>Department</code>/<code>Employee</code> example seems to fit the bill.</p><br /><pre><br />@Entity<br />public class Department {<br />  @OneToMany<br />  private Collection&lt;Employee&gt; employees;<br />}<br /></pre><br /><br />Now, here's a simple Spring DAO that is used to load all the <code>Department</code>s.<br /><pre><br />public class DepartmentDao extends HibernateDaoSupport {<br />  public List&lt;Department&gt; getDepartments() {<br />    return getHibernateTemplate().loadAll(Department.class);<br />  }<br />}<br /></pre><br /><br /><p>Okay.&nbsp; This all works great.&nbsp; Let's make one <i>little </i>change to have the <code>Employee</code>'s loaded eagerly instead of lazily.</p><br /><pre><br />@Entity<br />public class Department {<br />  @OneToMany(fetch=FetchType.EAGER)<br />  private Collection&lt;Employee&gt; employees;<br />}<br /></pre><br /><br /><p>With this one <i>little</i> change, the shit hits the fan.&nbsp; Now, duplicate <code>Department</code>s show up on my listing page.&nbsp; Why the hell are duplicates showing up?&nbsp; Hibernate uses an <i>outer join</i> to eagerly load all of the <code>Employee</code> information with the <code>Department</code>.&nbsp; So, when it queries for all <code>Department</code>s, you're actually getting back the same <code>Department</code> multiple times (one time for each <code>Employee</code>).</p><br /><br /><p>I could swear that this is a bug, but according to the Hibernate folks, it appears to be <a href="http://www.hibernate.org/117.html"><i>Working as Designed</i></a>. So, I whipped up a little helper method to filter out all the duplicates.&nbsp; It literally took my two hours to figure out that Hibernate was the problem and not my code.&nbsp; Anyone else out there been bit by this behavior before?</p><br /><br /><pre><br />public class DepartmentDao extends HibernateDaoSupport {<br />  public List&lt;Department&gt; getDepartments() {<br />    return loadAllUnique(Department.class);<br />  }<br /><br /> /**<br />  * Loads all the unique instances of a given Class (to work around issue with duplicate<br />  * rows when eagerly fetching collections).<br />  *<br />  * @see http://www.hibernate.org/117.html<br />  */<br />  private List loadAllUnique(Class clazz) {<br />    return new ArrayList(new LinkedHashSet(getHibernateTemplate().loadAll(clazz)));<br />  }<br />}<br /></pre></div>
