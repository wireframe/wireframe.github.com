---
layout: post
title: "Bundler Nirvana With Custom Groups"
date: 2012-05-03
comments: false
categories:
 - ruby
 - rails
---

<div class='post'>
<p>Managing gem dependencies in Rails applications has been an ongoing struggle over the years.  Anyone out there still remember vendoring and freezing gems/plugins into their application?  Ah yes, the good old days.  Thank goodness for <a href="http://gembundler.com/">bundler</a>.  For all of it's warts, it's an exceptional piece of software and has made my life <em>infinitely</em> better.</p> <p>The basics of bundler are all well and good, but my goal here is to take your bundler-fu to the next level.</p> <h2>The Problem</h2> <p>As applications grow, managing your Gemfile dependencies is an ongoing issue.  The number of dependencies grows...and grows...and grows, until you are no longer able to grok what your application needs to get up and running with a simple visual scan.</p> <h2>Enter Custom Bundler Groups!</h2> <p>Inspired by the great article by <a href="http://iain.nl/getting-the-most-out-of-bundler-groups">Iain Hecker</a>, I began exploring more advanced usage of bundler groups.  The <a href="http://blog.codecrate.com/2012/03/rails-console-tweaks-gem.html">rails-console-tweaks gem</a> was a step in the right direction, but there's plenty more work to be done!</p> <p>After launching a few Rails applications from the ground up, I found a number of reusable themes that could be expressed quite well using bundler groups.</p> <p>At a minimum, a basic Rails application should have a bundle group for each of these areas:</p> <ul><li>:app - gems for front end appservers (ex: rack middleware)</li><li>:worker - gems for resque backend processing jobs (ex: resque-ensure-connected)</li><li>:console - gems for firing up a rails console (ex: hirb, awesome_print)</li><li>:development - gems for day to day development tasks (ex: email_preview, mailcatcher, etc)</li><li>:test - gems for running testcases (ex: rspec, webmock, etc)</li><li>:debug - gems for firing up the debugger (ex: pry)</li><li>:darwin/:linux/etc - gems specific to your particular OS (ex: growl) (might be improved at some point see https://github.com/carlhuda/bundler/issues/663)</li><li>:ci - gems for running continuous integration by automated build processes (ex: jslint)</li><li>:ct - gems for continuous testing workflow (ex: guard, autotest, etc)</li></ul> <p><a href="https://gist.github.com/raw/2589028/a03f649b838fc9e4ecf93a3a239cac37d111e9da/Gemfile">An example annotated skeleton Gemfile is available in this Gist.</a></p> <p>Adding these specialized bundler groups gives your app an instant boost in:</p> <ul><li>Clarity - Each of these self describing groups will help avoid paralysis when you get 100+ gems in your app</li><li>Speed - I've personally seen a 500ms difference in application startup time for even a simple usecase.  Every little bit helps!</li><li>Safety - Isolating non-prodution gems from your production environment.</li></ul> <h2>Putting the pieces together...</h2> <p>Once you have grouped your gem dependencies, the next step is to ensure that the proper groups are loaded in the proper places.</p> <h3>Rails Application Config</h3> <p>The Rails <code>application.rb</code> config file is used to declare which custom groups are loaded based on the current Rails environment (production, development or test).  In our configuration, we want to ensure that the debug gems are loaded into our development and test environments.</p> <script src="https://gist.github.com/2589028.js?file=application.rb"></script>  <h3>Rack Appserver Config</h3> <p>The appserver specific gems are autoloaded using the Rack <code>config.ru</code> configuration file by configuring the standard <code>RAILS_GROUPS</code> environment variable.  It's a simple and elegant solution.</p> <script src="https://gist.github.com/2589028.js?file=config.ru"></script>  <h3>Resque Background Job Config</h3> <p>Autoloading gems into your background workers can also easily be done by passing the <code>RAILS_GROUPS</code> config to your resque workers.</p> <pre><code>$ RAILS_GROUPS=worker QUEUES=* RAILS_ENV=production rake resque:work<br /></code></pre> <h3>Capistrano Deployment Config</h3> <p>It's important to make sure that these development and test gems are excluded from your production environment.  It's quite easy to tweak the Rails default capistrano deployment task to exclude additional custom groups</p> <script src="https://gist.github.com/2589028.js?file=deploy.rb"></script>  <h2>Versioning Best Practices</h2> <p>When building your Gemfile, It's important to lock down <strong>all</strong> production gems with a <strong>STRICT</strong> version requirement (ex: "1.0.0").  This prevents a careless developer from running "bundle update" and pulling in gems that are not fully tested.  On the other hand, it is highly recommended to use a <strong>LOOSE</strong> version requirement for development and test gems to easily upgrade to the bleeding edge version (ex: "~&gt; 1.0.0").</p> <p>A full list of all files referenced in this post can be found <a href="https://gist.github.com/2589028">in this Gist</a>.  Comments and suggestions are always welcome!</p></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Ryan Sonnek</div>
<div class='content'>
Thanks for the comment. I&#39;ve updated the gist URL.</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
Thx for the useful post!  Looks like the link for &quot;in this Gist&quot; should be pointing to https://gist.github.com/2589028.  (just missing the 8)</div>
</div>
</div>
