---
layout: post
title: "callback_skipper for faster factories"
date: 2011-11-28
comments: false
categories:
 - ruby
 - performance
 - rails
 - testing
---

<div class='post'>
<p><a href="http://www.flickr.com/photos/brentbat/2137221211"><img src="http://farm3.staticflickr.com/2194/2137221211_6d705baeae.jpg"></a></p> <p>The Rails community has taken a strong stance that <a href="http://railscasts.com/episodes/158-factories-not-fixtures">test fixtures are evil and factories are the new hotness</a>.  The most compelling reason for this shift being that factories greatly reduce maintance costs as your application grows over time.</p> <p>The largest drawback when replacing fixtures with factories is the additional performance overhead when initializing your test state.  This is due to the fact that factories utilize the full ActiveRecord lifecycle (initialize object, validate, save to database) compared to fixtures which are a glorified database bulk import which bypass object creation/validation.</p> <p>Take this example ActiveRecord model and testcase (using <a href="https://github.com/thoughtbot/factory_girl">FactoryGirl</a> factories):</p> <pre><code>class Foo &lt; ActiveRecord::Base<br />  after_create :do_something_expensive<br />end<br /><br />def test_new_instance_has_bar<br />  foo = Factory.create :foo<br /><br />  assert foo.bar?<br />end<br /></code></pre> <p>This is a classic example where using factories will be much slower than fixtures.  It may not seem like a big deal, but it becomes a real issue when you have a sizable application testsuite, and I'm a firm believer that if a testsuite isn't fast, it doesn't get run.</p> <p>Sending email with <code>after_save</code> callback is another great usecase.  How can we get the benefits of factories without the additional overhead?  Can we have our cake and eat it too?</p> <p>Since 99% of our testcases rely on the basic factory instance and are not dependent upon the expensive callback being fired, it would be ideal to skip the expensive callback for most of your testcases and only fire it for testscases that are explicitly asserting it's behavior.</p> <p>The newly released <a href="https://github.com/wireframe/callback_skipper">callback_skipper gem</a> fulfills this exact usecase.  The goal is to make it trivial to skip a particular model callback for a specific instance.  This is a homerun for test factories to setup a default factory which skip non-critical callbacks and still have the flexibility to create a factory that <em>does</em> fire the slow-ass callbacks for specific tests.</p> <pre><code># spec/factories/foo_factory.rb<br />Factory.define :foo do |f|<br />  f.after_build do |o|<br />    o.skip_callback :save, :after, :do_something_expensive<br />  end<br />end<br />Factory.define :foo_with_expensive_callback, :class =&gt; 'Foo' do |f|<br />end<br /></code></pre> <p>Oh yes, we <em>can</em> have our cake and eat it too...</p> <p>The callback_skipper gem is equivalent to the core <a href="https://github.com/wireframe/callback_skipperhttp://api.rubyonrails.org/classes/ActiveSupport/Callbacks/ClassMethods.html#method-i-skip_callback"><code>ActiveRecord.skip_callback</code></a> method with the added benefit of only skipping the callback for a specific instance instead of globally for all invocations.</p> <p>As always, the gem is 100% opensource and suggestions are welcome!</p></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Ryan Sonnek</div>
<div class='content'>
Andy, it totally depends on how much work your callbacks are doing.<br /><br />i&#39;ve found that sending emails via callbacks are a *very* common pattern, and it can be a quite expensive operation (upwards of 1sec per email).<br /><br />so, your milage will vary depending on how expensive your callbacks are.</div>
</div>
<div class='comment'>
<div class='author'>Andy</div>
<div class='content'>
Hi Ryan, interesting idea. Do you have any benchmarks showing the improvement by skipping callbacks in your test suite?</div>
</div>
</div>
