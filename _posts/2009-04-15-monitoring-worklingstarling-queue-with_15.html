---
layout: post
title: "Monitoring workling/starling queue with GOD"
date: 2009-04-15
comments: false
categories:
 - ruby
---

<div class='post'>
<p><em>Everyone</em> knows that there's no decent ruby solution for monitoring server side processes.  <br /><a href="http://god.rubyforge.org">GOD</a> is the best option we have (<a href="http://twitter.com/wireframe6464/status/1511506770">for now</a>), and we have to make do with the tools at hand.  It is an absolutely cryptic and arcane library to work with, but luckily it is easily extensible to add new functionality.</p><br /><br /><p>I've been using starling/workling in my current project and needed to monitor the health of my starling queue.  There can be sudden bursts of load on my starling queue, and the workling processes may fall behind and not process items in the queue fast enough.  There is a <code>starling_status</code> script that can be used to manually check on the health of the queue, but I got a little tired of sitting at my keyboard day after day periodically running the script. </p><br /><br /><p>So, I wrote up a monitoring task that will notify me when the queue is backed up, and when/if it recovers back to a good state.  Just drop this into your existing GOD configuration script, and tweak for the queue you need to monitor.</p><br /><pre><br />God.task do |w|<br />  w.name = "starling-queue"<br />  w.interval = 1.minute<br />  w.valid_states = [:healthy, :backed_up]<br />  w.initial_state = :healthy<br /><br />  require 'yaml'<br />  config = YAML.load_file("#{RAILS_ROOT}/config/workling.yml")[RAILS_ENV]<br />  w.transition(:healthy, :backed_up) do |on|<br />    on.condition(:queue_size) do |c|<br />      c.port = config['listens_on']<br />      c.queue = 'queue_my_workers__my_queue_items'<br />      c.greater_than_size = 100<br />    end<br />  end<br />  w.transition(:backed_up, :healthy) do |on|<br />    on.condition(:queue_size) do |c|<br />      c.port = config['listens_on']<br />      c.queue = 'queue_my_workers__my_queue_items'<br />      c.less_than_size = 100<br />    end<br />  end<br />end<br /></pre><br /><br /><p>Here is the GOD extension to connect and monitor the health of the starling queue.  To install it, simply copy this code into your GOD configuration script as well.</p><br /><pre><br />module God<br />  module Conditions<br />    class QueueSize < PollCondition<br />      require 'starling'<br />      attr_accessor :port, :queue, :less_than_size, :greater_than_size<br />      <br />      def initialize<br />        super<br />        self.port = nil<br />        self.queue = nil<br />        self.less_than_size = nil<br />        self.greater_than_size = nil<br />      end<br />      <br />      def valid?<br />        valid = true<br />        valid &= complain("Attribute 'port' must be specified", self) if self.port.nil?<br />        valid &= complain("Attribute 'queue' must be specified", self) if self.queue.nil?<br />        valid &= complain("Attribute 'less_than_size' or 'greater_than_size' must be specified", self) if self.greater_than_size.nil? && self.less_than_size.nil?<br />        valid<br />      end<br />      <br />      def test<br />        server = Starling.new(self.port)<br />        remaining = server.stats[self.port][self.queue]<br />        if self.less_than_size<br />          remaining.to_i < self.less_than_size<br />        else<br />          remaining.to_i > self.greater_than_size<br />        end<br />      end<br />    end<br />  end<br />end<br /></pre><br /><br /><p>I only wish there was another option other than GOD to do this.  Writing the extension was fairly straight forward, but the DSL for configuring transitions is absolutely awful.  Maybe someone can write a <strong>usable</strong> DSL that re-uses the GOD extensions and exposes a more "humane" interface.</p></div>
