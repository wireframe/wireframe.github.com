---
layout: post
title: "Fork it up - assert valid markup"
date: 2008-12-22
comments: false
categories:
 - ruby
 - testing
---

<div class='post'>
<p>Unit testing view layers has always been a difficult problem for me.&nbsp; I haven't run across a lot of libraries that I've found valuable, mainly because they're too slow.&nbsp; I've found that no matter how good the tests are, if they're slow, they don't get run.</p><p>I was pretty excited when I ran across the <a href="http://github.com/wr0ngway/assert_valid_markup/tree/master">assert_valid_markup plugin</a> which allows me to unit test that my pages are xhtml compliant.&nbsp; It's wicked fast because it relies on locally installed binaries (xmllint), but it also has a nice fallback to use the w3c xml validation service.</p><p>The syntax for the plugin is very slick and doesn't require any unnecessary setup.<br /></p><pre>class FooControllerTest &lt; Test::Unit::TestCase<br />  assert_valid_markup :index, :show<br />end<br /></pre><p>I've been using this plugin for about a month, and ran across a pretty major issue today when running my unit tests on our continuous integration server (Cruisecontrol). &nbsp; All tests ran great on my local instance, but tests were failing in our shared environment with some very cryptic error messages.<br /></p><p><em>no such file to load -- FileUtils<br /><br />/usr/local/lib/ruby/site_ruby/1.8/rubygems/custom_require.rb:27:in<br />`gem_original_require'<br /><br />/usr/local/lib/ruby/site_ruby/1.8/rubygems/custom_require.rb:27:in<br />`require'<br /><br />/usr/local/lib/ruby/gems/1.8/gems/activesupport-2.2.2/lib/active_support/dependencies.rb:153:in<br />`require'<br /><br />/usr/local/lib/ruby/gems/1.8/gems/activesupport-2.2.2/lib/active_support/dependencies.rb:521:in<br />`new_constants_in'<br /><br />/usr/local/lib/ruby/gems/1.8/gems/activesupport-2.2.2/lib/active_support/dependencies.rb:153:in<br />`require'<br /><br />/home/eventrobot/.cruise/projects/socialcast/work/vendor/plugins/assert_valid_markup/lib/assert_valid_markup.rb:5<br />/usr/local/lib/ruby/site_ruby/1.8/rubygems/custom_require.rb:27:in `gem_original_require'&nbsp;<br /><br /></em><br /></p><p>After digging through the plugin source code, I did what any inquisitive developer would do, <strong>FORK IT UP</strong>! <a href="http://github.com/wireframe/assert_valid_markup/commit/637088fbd8ff8d1d507a8d07403ca92e04b9a684%20%20">A small change</a> to the plugin and I was back up and running...almost.&nbsp; Another issue cropped up when running the tests through Cruisecontrol.<br /></p><p><em>/usr/local/bin/ruby -Ilib:test<br />&quot;/usr/local/lib/ruby/gems/1.8/gems/rake-0.8.3/lib/rake/rake_test_loader.rb&quot;<br /><br />/usr/local/lib/ruby/site_ruby/1.8/rubygems/custom_require.rb:27:in<br />`gem_original_require': no such file to load --<br />active_support/breakpoint (MissingSourceFile) <br />from<br />/usr/local/lib/ruby/site_ruby/1.8/rubygems/custom_require.rb:27:in<br />`require'<br />from<br />/usr/local/lib/ruby/gems/1.8/gems/activesupport-2.2.2/lib/active_support/dependencies.rb:153:in<br />`require' <br />from<br />/usr/local/lib/ruby/gems/1.8/gems/activesupport-2.2.2/lib/active_support/dependencies.rb:521:in<br />`new_constants_in' <br />from<br />/usr/local/lib/ruby/gems/1.8/gems/activesupport-2.2.2/lib/active_support/dependencies.rb:153:in<br />`require' <br />from ./vendor/plugins/ez-where/test/test_helper.rb:6&nbsp;<br /><br /></em></p><p>Tracking down this issue was a real pain.&nbsp; I spend the majority of my afternoon banging my head against the wall, but <a href="http://github.com/wireframe/assert_valid_markup/commit/5883b603b5cf6381fc75364756d496f30c886cdf%20%20">I eventually tracked it down</a>.&nbsp; Tests are now up and running, and I have a github project with all of my fixes available for anyone to check out.&nbsp; I'm still not 100% clear on the differences between my local environment and cruisecontrol, but that's for another time.</p><p>I may take this fork a bit further and turn it into a ruby gem instead of a rails plugin.&nbsp; It seems better suited that way now that I ripped out the rails initializer code.<br /><br /></p></div>
