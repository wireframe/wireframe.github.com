---
layout: post
title: "Unit Testing with Nested Contexts"
date: 2010-12-09
comments: false
categories:
 - testing
---

<div class='post'>
Nesting contexts and assertions is a more advanced and&nbsp;<b>incredibly</b>&nbsp;powerful aspect of several modern unit test frameworks (shoulda, jspec, etc).  It is both a blessing <i>and</i> a curse.  Using context nesting in most situations is a great way to reuse common data or environmental setup, but it <b>must</b>&nbsp;be applied judiciously to keep tests from getting out of control.<br /><br />Here's a very basic example using Shoulda.  The parent context is a simple environmental setup that can be reused for multiple tests...<br /><pre>context "when user is logged in" do<br />  #setup data<br />  setup do<br />    @user = User.new<br />    login_as @user<br />  end<br /><br />  #execute (within the scope of the previous setup)<br />  context "get home page" do<br />    setup do<br />      get :home<br />    end<br /><br />    #assert<br />    should redirect_to('/activate')<br />  end<br /><br />  #execute (within the scope of the *parent* context)<br />  context 'get help page' do<br />    setup do<br />      get :help<br />    end<br />    should redirect_to('/activate')<br />  end<br />end<br /></pre><br />The context descriptions are particularly important when nesting since context contributes a substring of your complete assertion.  For example, the previous test reads as:<br /><b>"when user is logged in, get home page should redirect to /activate"</b><br /><b>"when user is logged in, get help page should redirect to /activate"</b><br /><br /><h3>Complexity of Nested Contexts</h3>Using nested contexts does increase your test complexity and heavily nested contexts can be&nbsp;ridiculously&nbsp;difficult to read. If your tests begin nesting several levels of setup, you can easily lose track of what your execution context is when writing tests.  <br /><br />There is a very compelling argument for restricting nested contexts and collapsing multiple setups into one verbose setup block.  A good rule of thumb is that if the concatenated contexts no longer make a humane understandable sentence, it's time to refactor the test.<br /><br /><pre>context "when user is logged in" do<br />  #setup used for all nested contexts...<br />  setup do<br />    @user = User.new<br />    login_as @user<br />  end<br /><br />  context "and the user's timezone is EST" do<br />    #more setup...<br />    setup do<br />      @user.timezone = 'EST'<br />    end<br /><br />    #execute...umm...what scope am i actually running in?<br />    context 'get home page' do<br />      setup do<br />        get :home<br />      end<br />      should redirect_to('/activate')<br />    end<br />  end<br />end<br /></pre><br />By inlining the nested blocks, this test becomes:<br /><pre>#setup and execute (note the more verbose description)<br />context "get home page when user is logged in and user's timezone is EST" do<br />  setup do<br />    @user = User.new<br />    login_as @user<br />    @user.timezone = 'EST'<br />     get :home<br />  end<br />  should redirect_to('/activate')<br />end<br /></pre></div>
